name: Membrowse Memory Report

on:
  pull_request:
  push:
    branches:
      - master

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-esp32s3:
    runs-on: ubuntu-24.04
    container: espressif/idf:v5.3.1
    steps:
      - name: Clone LVGL as a Component
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          submodules: recursive
          path: components/lvgl

      - name: Copy IDF Project Example
        run: . /opt/esp/idf/export.sh && cp -r $IDF_PATH/examples/get-started/hello_world/* .

      - name: Set Target ESP32S3
        run: . /opt/esp/idf/export.sh && idf.py set-target esp32s3

      - name: Build
        run: . /opt/esp/idf/export.sh && idf.py build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: esp32s3-build
          path: |
            build/hello_world.elf
            build/esp-idf/esp_system/ld/memory.ld

  analyze:
    needs: build-esp32s3
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: esp32s3-build
          path: build

      - name: Run Membrowse PR Action
        id: analyze
        continue-on-error: true
        uses: membrowse/membrowse-action@v1
        with:
          target_name: esp32s3
          elf: build/hello_world.elf
          ld: build/esp-idf/esp_system/ld/memory.ld
          linker_vars: ""
          api_key: ${{ secrets.MEMBROWSE_API_KEY }}
          api_url: ${{ vars.MEMBROWSE_API_URL }}
          verbose: INFO

      - name: Upload report artifact
        if: ${{ steps.analyze.outcome == 'success' }}
        uses: actions/upload-artifact@v4
        with:
          name: membrowse-report-esp32s3
          path: ${{ steps.analyze.outputs.report_path }}
